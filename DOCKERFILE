# --- STAGE 1: Build la aplicación (usando Node.js 20 LTS) ---
# Usamos la imagen oficial de Node.js 20 LTS (Long Term Support)
# La variante "alpine" es más ligera y recomendable para Docker.
FROM node:20-alpine AS builder

# Establece el directorio de trabajo dentro del contenedor
WORKDIR /app

# Copia los archivos de configuración del proyecto primero
# para aprovechar el caché de Docker si solo cambian estos archivos.
# Copia package.json y package-lock.json
COPY package.json package-lock.json ./

# Instala las dependencias del proyecto.
# `npm ci` es preferido sobre `npm install` en entornos de CI/CD/Docker
# porque garantiza una instalación limpia y reproducible basada en package-lock.json.
# Si tienes problemas con el cache de npm ci, puedes agregar --prefer-offline
# o --no-fund --no-audit.
RUN npm ci

# Copia el resto del código de tu aplicación
COPY . .

# Construye la aplicación Vite para producción.
# Asegúrate de que el script "build" esté definido en tu package.json
# (ej. "build": "vite build").
RUN npm run build

# --- STAGE 2: Servir la aplicación (usando Nginx para producción) ---
# Nginx es un servidor web ligero y eficiente para servir archivos estáticos.
FROM nginx:alpine

# Copia los archivos de build generados por Vite desde la etapa "builder"
# al directorio por defecto de Nginx para servir archivos estáticos.
COPY --from=builder /app/dist /usr/share/nginx/html

# Elimina la configuración por defecto de Nginx y copia tu propia configuración.
# Esto es opcional, pero recomendado si necesitas configuraciones específicas (ej. reescrituras).
# Crea un archivo nginx.conf en la raíz de tu proyecto si lo necesitas,
# por ahora, usaremos una configuración básica si no lo tienes.
# Si no tienes un nginx.conf personalizado, puedes omitir estas dos líneas
# y Nginx usará su configuración por defecto que suele servir HTML.
# COPY nginx.conf /etc/nginx/conf.d/default.conf

# Expone el puerto 80 del contenedor, que es donde Nginx escucha por defecto.
EXPOSE 80

# Comando para iniciar Nginx cuando el contenedor se inicie
CMD ["nginx", "-g", "daemon off;"]